<?xml version="1.0" encoding="utf-8"?>
<XSN Name="Milex.xsn">

  <Table Name="Clients" UID="{5D96F9CC-ABC6-4086-A9B5-D9881C517D1C}" Alias="clts" LocalName="Клиент" LocalListName="Клиенты" TitleName="FIO">
    <Fields>
      <Field UID="{55D8E04F-77E0-4626-BE15-A25ABACD445B}" Name="FIO" Type="String" LabelName="ФИО" LocalListName="ФИО" NotNull="true"/>
      <Field UID="{F4597F21-5A0D-492D-885F-F75DFC02059F}" Name="Type" Type="Int" LabelName="Тип клиента" LocalListName="Тип клиента"/>
      <Field UID="{CFBE1C84-39C5-4BF1-B1F4-18EE1C3894DB}" Name="Phone" Type="PhoneBase" LabelName="Телефон" LocalListName="Телефон" NotNull="true"/>
      <Field UID="{24326925-AA50-468D-8CA4-B82C0C250F63}" Name="EMail" Type="EMail" LabelName="Электронная почта" LocalListName="Электронная почта" HideFromList="true"/>
      <Field UID="{7F43D0F9-9AAD-42DE-B6B8-DA1D5F4676E7}" Name="Birthday" Type="Birthday" LabelName="Дата рождения" LocalListName="Дата рождения" NotNull="true"/>
      <Field UID="{F70D52EB-54F2-4EC6-ABD2-C9D2ED228CFE}" Name="Address" Type="Address" LabelName="Адрес" LocalListName="Адрес" HideFromList="true"/>
      <Field UID="{8B115D92-7593-49AC-A887-6B0B7CCC6E62}" Name="Note" Type="String" LabelName="Примечание" LocalListName="Примечание"/>
      <Field UID="{07B7015C-21F9-40F6-8447-CE6F828F0D3B}" Name="Discount" Type="Int" LabelName="Скидка" LocalListName="Скидка"/>
      <Field UID="{B4351BD7-C9C3-4AA1-8541-68A9A3744177}" Name="ExistDebt" Type="Bool" LabelName="Наличие долга" LocalListName="Наличие долга" QueryText="(SELECT SUM(sbsr_debt)::INTEGER::BOOLEAN FROM subscriptions WHERE sbsr_client = clts_id)"/>
    </Fields>
    <Indexes>
      <Index Field="Type"/>
      <Index Field="FIO" Unique="true"/>
      <Index Field="Phone"/>
      <Index Field="EMail"/>
      <Index Field="Birthday"/>
      <Index Field="Address"/>
      <Index Field="Note"/>
      <Index Field="Discount"/>
      <Index Field="FIO;Birthday"/>
    </Indexes>
    <Foreigns>
      <Foreign Field="Type" ForeignClass="ClientType" ForeignField="ID" ForeignViewNameField="Name"/>
      <Foreign Field="Discount" ForeignClass="Discount" ForeignField="ID" ForeignViewNameField="Name;Percent"/>
    </Foreigns>
  </Table>

  <Table Name="ClientType" UID="{8D1EC261-F532-40CE-B707-0B3BC1887CBB}" Alias="cltp" LocalName="Тип клиента" LocalListName="Типы клиентов" TitleName="Name">
    <Fields>
      <Field UID="{BF5399F9-61C3-47CE-8E2E-12627795F9DB}" Name="Name" Type="String" LabelName="Наименование" LocalListName="Наименование" NotNull="true"/>
    </Fields>
    <Indexes>
      <Index Field="Name" Unique="true"/>
    </Indexes>
  </Table>

  <Table Name="Card" UID="{FD0E745C-519A-4CA5-B23C-79173A4B19D6}" Alias="card" LocalName="Карта клиента" LocalListName="Карты клиентов" TitleName="Barcode">
    <Fields>
      <Field UID="{9B44BC32-8CB7-4B1F-B8F3-CB835E7E591B}" Name="Client" Type="Int" LabelName="Клиент" LocalListName="Клиент" NotNull="true"/>
      <Field UID="{BDCF0F6E-EBAB-4ED5-B34D-31971F0A4E79}" Name="Barcode" Type="String" ReadOnly="true" LabelName="Штрих-код" LocalListName="Штрих-код" NotNull="true"/>
      <Field UID="{1D60ECBB-BABC-448D-BA2E-40C1A47B5AAD}" Name="Active" Type="Bool" DefaultValue="true" LabelName="Активна" LocalListName="Активна" HideFromObject="true"/>
      <Field UID="{032BADE0-C3B0-4304-95D3-231057614CDC}" Name="Reason" Type="String" LabelName="Причина деактивации" LocalListName="Причина деактивации" HideFromObject="true"/>
    </Fields>
    <Indexes>
      <Index Field="Client"/>
      <Index Field="Barcode" Unique="true"/>
      <Index Field="Active"/>
      <Index Field="Reason"/>
    </Indexes>
    <Foreigns>
      <Foreign Field="Client" ForeignClass="Clients" ForeignField="ID" ForeignViewNameField="FIO"/>
    </Foreigns>
  </Table>

  <Table Name="Subscriptions" UID="{5C38B8CE-B105-4A63-B492-CE813C59E3C9}" Alias="sbsr" LocalName="Абонемент" LocalListName="Абонемент" TitleName="Date" ObjectForm="ISPatriotSubscriptionObjectForm">
    <Fields>
      <Field UID="{C15DCF45-3FE4-4DC4-B497-97C286621F71}" Name="Date" Type="Date" DefaultValue="CURRENT_DATE" LabelName="Дата регистрации" LocalListName="Дата регистрации" NotNull="true" HideFromObject="true"/>
      <Field UID="{EF9A7374-6491-4D9A-A785-3736626704BB}" Name="Client" Type="Int" LabelName="Клиент" LocalListName="Клиент" NotNull="true"/>
      <Field UID="{6A90BC21-488E-4861-BE95-738C271E4E86}" Name="Trainer" Type="Int" LabelName="Тренер" LocalListName="Тренер" NotNull="true"/>
      <Field UID="{6601E232-E81A-4589-AA8B-A50B54BF1117}" Name="Type" Type="Int" LabelName="Тип абонемента" LocalListName="Тип абонемента" NotNull="true"/>
      <Field UID="{DC69FC76-4644-42FB-A0F4-CB42325DBCFD}" Name="Note" Type="String" LabelName="Примечание" LocalListName="Примечание"/>
      <Field UID="{9E9F9F84-AE7C-46BB-AFEA-EFB249BC0A4C}" Name="LeftCount" Type="Int" LabelName="Осталось посещений" LocalListName="Осталось посещений" HideFromObject="true"/>
      <Field UID="{4A34C2B9-1073-4F77-A5D9-10201EE9390E}" Name="NowExist" Type="Bool" DefaultValue="false" LabelName="Сейчас присутствует" LocalListName="Сейчас присутствует" HideFromObject="true"/>
      <Field UID="{48E0D209-D19D-4658-9246-3C2517EDF9FD}" Name="Price" Type="Double" ReadOnly="true" LabelName="Цена продажи" LocalListName="Цена продажи" HideFromObject="true"/>
      <Field UID="{AADE44EE-0A46-44CC-89FF-7D06F942FF3B}" Name="Debt" Type="Double" LabelName="Долг" LocalListName="Долг"/>
    </Fields>
    <Indexes>
      <Index Field="Date"/>
      <Index Field="Client"/>
      <Index Field="Trainer"/>
      <Index Field="Type"/>
      <Index Field="Note"/>
      <Index Field="LeftCount"/>
      <Index Field="NowExist"/>
      <Index Field="Price"/>
      <Index Field="Debt"/>
    </Indexes>
    <Foreigns>
      <Foreign Field="Client" ForeignClass="Clients" ForeignField="ID" ForeignViewNameField="FIO"/>
      <Foreign Field="Trainer" ForeignClass="Trainer" ForeignField="ID" ForeignViewNameField="FIO"/>
      <Foreign Field="Type" ForeignClass="SubscriptionType" ForeignField="ID" ForeignViewNameField="Name"/>
    </Foreigns>
  </Table>

  <Table Name="SubscriptionType" UID="{F9093D52-6623-45FF-B930-52C902CB43F9}" Alias="sbtp" LocalName="Тип абонемента" LocalListName="Типы абонементов" TitleName="Name">
    <Fields>
      <Field UID="{4B913CA6-09FE-4E3E-8B29-B9F9C207EFA1}" Name="Name" Type="String" LabelName="Наименование" LocalListName="Наименование" NotNull="true"/>
      <Field UID="{90409CDA-56FA-4956-BD47-1DC287D9AEDB}" Name="Count" Type="Int" LabelName="Количество посещений" LocalListName="Количество посещений" NotNull="true"/>
      <Field UID="{F7DA5FBB-D780-4EF5-B089-FBE2F5A67AF2}" Name="Cost" Type="Double" LabelName="Стоимость" LocalListName="Стоимость" NotNull="true"/>
    </Fields>
    <Indexes>
      <Index Field="Name" Unique="true"/>
      <Index Field="Count"/>
      <Index Field="Cost"/>
    </Indexes>
  </Table>

  <Table Name="Trainer" UID="{D63E3910-9F01-4F87-8F00-883335B5E501}" Alias="trnr" LocalName="Тренер" LocalListName="Тренеры" TitleName="FIO">
    <Fields>
      <Field UID="{A8010153-C59F-41E8-A627-771E25FEE2E3}" Name="FIO" Type="String" LabelName="ФИО" LocalListName="ФИО" NotNull="true"/>
      <Field UID="{781A0EC1-61AF-4D76-9C80-5A2F7697948C}" Name="Birthday" Type="Birthday" LabelName="Дата рождения" LocalListName="Дата рождения" NotNull="true"/>
      <Field UID="{E37417A4-2933-4CF9-9B0F-10DA325A01C1}" Name="Phone" Type="PhoneBase" LabelName="Телефон" LocalListName="Телефон" NotNull="true"/>
    </Fields>
    <Indexes>
      <Index Field="FIO"/>
      <Index Field="Birthday"/>
      <Index Field="Phone"/>
      <Index Field="FIO;Birthday"/>
    </Indexes>
  </Table>

  <Table Name="Visit" UID="{5778F034-85D5-4D6E-A7AC-775BD6E28A9B}" Alias="vist" ShowOnly="true" LocalName="Посещение" LocalListName="Посещения" TitleName="FIO">
    <Fields>
      <Field UID="{734BA1A1-7E13-49D9-BABD-FEF439DF35EC}" Name="Subscription" Type="Int" LabelName="Абонемент" LocalListName="Абонемент" HideFromList="true"/>
      <Field UID="{134D71F8-49A8-4279-94CF-9342D4C79C0C}" Name="Client" Type="String" LabelName="Клиент" LocalListName="Клиент" QueryText="SELECT clts_fio FROM clients WHERE clts_id = (SELECT sbsr_client FROM subscriptions WHERE sbsr_id = vist_subscription)"/>
      <Field UID="{0F97A344-DA52-4B82-BD80-AC300633BF8F}" Name="SubscriptionName" Type="String" LabelName="Абонемент" LocalListName="Абонемент" QueryText="SELECT sbtp_name FROM subscriptions LEFT JOIN subscriptiontype ON sbtp_id = sbsr_type WHERE sbsr_id = vist_subscription"/>
      <Field UID="{184A08E3-C0B8-4D6B-8C34-95BE9825F91F}" Name="Date" Type="Date" DefaultValue="CURRENT_DATE" LabelName="Дата" LocalListName="Дата" NotNull="true"/>
      <Field UID="{9D168E0E-2B9A-485E-AA75-C3693EDF6357}" Name="Begin" Type="Time" DefaultValue="CURRENT_TIME" LabelName="Начало" LocalListName="Начало" NotNull="true"/>
      <Field UID="{C02B8A40-614A-4A8C-87D0-114C4DA4F8E0}" Name="End" Type="Time" LabelName="Окончание" LocalListName="Окончание"/>
      <Field UID="{758EE49C-EAB6-4D9A-815D-430BD6F73AD8}" Name="Duration" Type="Time" LabelName="Длительность" LocalListName="Длительность"/>
    </Fields>
    <Indexes>
      <Index Field="Subscription"/>
      <Index Field="Begin"/>
      <Index Field="End"/>
      <Index Field="Duration"/>
    </Indexes>
    <Foreigns>
      <Foreign Field="Subscription" ForeignClass="Subscriptions" ForeignField="ID"/>
    </Foreigns>
  </Table>

  <Table Name="Cost" UID="{AA246235-2594-4EFD-86B9-56B1EDF30726}" Alias="cost" LocalName="Расход" LocalListName="Расходы" TitleName="Name">
    <Fields>
      <Field UID="{7E3C1293-166E-48D4-90F0-AA903DADE463}" Name="Date" Type="Date" LabelName="от" LocalListName="от"/>
      <Field UID="{5A9808BF-6BFE-4007-9FBB-F3657C0300FF}" Name="Name" Type="String" LabelName="Наименование" LocalListName="Наименование" NotNull="true"/>
      <Field UID="{AE5C947C-21E2-4540-8A05-26A011AEF135}" Name="Type" Type="Int" LabelName="Тип расхода" LocalListName="Тип расхода"/>
      <Field UID="{276BF6C6-E083-4DA6-9A97-41E41F75E3E5}" Name="Sum" Type="Double" LabelName="Сумма" LocalListName="Сумма" NotNull="true"/>
      <Field UID="{99EA51DC-8744-41F5-9668-488621F8695E}" Name="Note" Type="String" LabelName="Примечание" LocalListName="Примечание"/>
    </Fields>
    <Indexes>
      <Index Field="Date"/>
      <Index Field="Name" Unique="true"/>
      <Index Field="Type"/>
      <Index Field="Sum"/>
      <Index Field="Note"/>
    </Indexes>
    <Foreigns>
      <Foreign Field="Type" ForeignClass="CostType" ForeignField="ID" ForeignViewNameField="Name"/>
    </Foreigns>
  </Table>

  <Table Name="CostType" UID="{34AE4129-3B90-4791-9377-DDC374E28D98}" Alias="cstp" LocalName="Тип расхода" LocalListName="Типы расходов" TitleName="Name">
    <Fields>
      <Field UID="{C0CFDE08-CDEE-4F02-88E9-8BC6BA17D17F}" Name="Name" Type="String" LabelName="Наименование" LocalListName="Наименование"/>
    </Fields>
    <Indexes>
      <Index Field="Name" Unique="true"/>
    </Indexes>
  </Table>

  <Table Name="Discount" UID="{7459C436-6D7E-403E-84D7-14017055F46B}" Alias="dcnt" LocalName="Скидка" LocalListName="Скидки" TitleName="Name">
    <Fields>
      <Field UID="{AB2396D4-0161-4CE5-8F18-7992D71CE046}" Name="Name" Type="String" LabelName="Наименование" LocalListName="Наименование"/>
      <Field UID="{EF56DD03-FBA7-40E7-9B5F-6B4750C50D98}" Name="Percent" Type="Percent" LabelName="Процент" LocalListName="Процент"/>
    </Fields>
    <Indexes>
      <Index Field="Name" Unique="true"/>
      <Index Field="Percent" Unique="true"/>
    </Indexes>
  </Table>

  <Table Name="TrainerReport" Parent="Subscriptions" UID="{D36FC2E3-EDB5-4AD4-B88B-73BA2EE25792}" Where="NOT sbsr_isdeleted AND sbsr_trainer = :TrainerID AND sbsr_date BETWEEN :DateBegin AND :DateEnd" OrderField="clts_fio">
    <Fields>
      <Field UID="{2D3C21DA-EEDE-418A-8109-ACE267481318}" Name="ClientFIO" Type="String" LocalListName="Клиент" QueryText="clts_fio"/>
      <Field UID="{E0B21845-64EC-4F2A-B1E4-82256F9DB1A9}" Name="Date" Type="Date" LocalListName="Дата регистрации" QueryText="sbsr_date"/>
      <Field UID="{BBCE6DC4-6198-4B6D-A9D5-C667AEB307C9}" Name="Type" Type="String" LocalListName="Абонемент" QueryText="sbtp_name"/>
      <Field UID="{966EF52E-961A-437B-B4E7-CEC0615C9CD9}" Name="Price" Type="Double" LocalListName="Цена продажи" QueryText="sbsr_price"/>
      <Field UID="{C8AC67A1-E98A-4512-BABD-1E4115555AE7}" Name="Count" Type="Int" LocalListName="Посещений в абонементе" QueryText="sbtp_count"/>
      <Field UID="{6B844D4A-BE2D-486D-BCE8-E4001F0FAB8D}" Name="LeftCount" Type="Int" LocalListName="Осталось помещений" QueryText="sbsr_leftcount"/>
      <Field UID="{2A2D4B2B-AB32-4562-BB56-6E3AE76D4361}" Name="Visit" Type="Int" LocalListName="Посещений" QueryText="sbtp_count - sbsr_leftcount"/>
    </Fields>
    <Joins>
      <Join Text="LEFT JOIN clients ON clts_id = sbsr_client"/>
      <Join Text="LEFT JOIN subscriptiontype ON sbtp_id = sbsr_type"/>
    </Joins>
  </Table>

</XSN>